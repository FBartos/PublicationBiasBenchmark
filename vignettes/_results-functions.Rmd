---
title: "results-functions"
output: html_document
---

```{r, include = FALSE}
# This is a child document meant to be included in other Rmd files
# Exit if being knit directly (not as a child)
if (!exists("dgm_names")) {
  message("This is a helper file that should be included as a child in other Rmd documents.")
  message("It requires 'dgm_names' to be defined in the parent document.")
  knitr::knit_exit()
}
```

```{r, include = FALSE}
make_table_summary <- function(results, common_scale = TRUE) {
  
  table_summary <- do.call(rbind, lapply(unique(results$label), function(ml) with(results[results$label == ml,],
    data.frame(
      "Method"      = unique(method),
      "Setting"     = unique(method_setting),
      "Convergence" = mean(convergence),
      "Bias"        = if (common_scale) mean(bias) else mean(bias_rank),
      "RMSE"        = if (common_scale) mean(rmse) else mean(rmse_rank),
      "Coverage"    = mean(coverage),
      "Error"       = mean(power[H0]),
      "Power"       = mean(power[!H0])
    ))
  ))  
  
  table_summary[["combined"]] <- rowMeans(table_summary[, c("RMSE", "Error", "Bias", "Coverage", "Power")])
  return(table_summary)
}
make_rank_summary  <- function(table_summary) {
  
  rank_summary <- table_summary

  for (measure in c("RMSE", "Error")) {
    rank_summary[[measure]]  <- rank(table_summary[[measure]], ties.method = "min")
  }
  for (measure in c("Convergence", "Coverage", "Power")) {
    rank_summary[[measure]]  <- rank(-table_summary[[measure]], ties.method = "min")
  }
  for (measure in c("Bias")) {
    rank_summary[[measure]]  <- rank(abs(table_summary[[measure]]), ties.method = "min")
  }

  rank_summary[["combined"]] <- rank(table_summary[["combined"]], ties.method = "min")

  return(rank_summary)
}
```
