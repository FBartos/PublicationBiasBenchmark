---
title: "results-main"
output: html_document
---

```{r, include = FALSE}
# This is a child document meant to be included in other Rmd files
# Exit if being knit directly (not as a child)
if (!exists("dgm_names")) {
  message("This is a helper file that should be included as a child in other Rmd documents.")
  message("It requires 'dgm_names' to be defined in the parent document.")
  knitr::knit_exit()
}
```

```{r, include = FALSE}
# Load and merge the 
# use pre-local results if compiled locally
if (dir.exists("C:/R-Packages/PublicationBiasBenchmark/resources")) {
  path <- "C:/R-Packages/PublicationBiasBenchmark/resources"
} else { 
  path <- NULL
}

# Specify methods to show in the results
methods_settings <- data.frame(
  method   = c("mean",    "FMA",     "RMA",     "PET",     "PEESE",   "PETPEESE", "WLS",     "WILS",    "WAAPWLS", "trimfill", "SM",   "SM",   "puniform",  "puniform", "pcurve",  "EK",      "AK",  "AK",  "RoBMA"),
  settings = c("default", "default", "default", "default", "default", "default",  "default", "default", "default", "default",  "3PSM", "4PSM", "default",   "star",     "default", "default", "AK1", "AK2", "PSMA")
)
methods_settings_labels <- with(methods_settings, paste0(method, " (", settings, ")"))

library(PublicationBiasBenchmark)
PublicationBiasBenchmark.options('prompt_for_download' = FALSE)
library(ggplot2)
library(ggdist)
library(scales)

results_conditional_list <- list()
results_replacement_list <- list()
for (dgm_name in dgm_names) {
  
  # retrieve all measures across all conditions and measures
  download_dgm_measures(dgm_name, path = path)
  temp_conditional <- retrieve_dgm_measures(dgm_name, path = path)
  temp_replacement <- retrieve_dgm_measures(dgm_name, replacement = TRUE, path = path)  
  
  # retrieve conditions
  conditions <- dgm_conditions(dgm_name)
  
  # add labels
  temp_conditional$label <- with(temp_conditional, paste0(method, " (", method_setting, ")"))
  temp_replacement$label <- with(temp_replacement, paste0(method, " (", method_setting, ")"))
  
  # keep only the requested methods
  temp_conditional <- temp_conditional[temp_conditional$label %in% methods_settings_labels,]
  temp_replacement <- temp_replacement[temp_replacement$label %in% methods_settings_labels,]
    
  temp_conditional$dgm_name <- dgm_name
  temp_replacement$dgm_name <- dgm_name
    
  # distinguish between H0 and H1
  temp_conditional$H0 <- temp_conditional$condition_id %in% conditions$condition_id[conditions$mean_effect == 0]
  temp_replacement$H0 <- temp_replacement$condition_id %in% conditions$condition_id[conditions$mean_effect == 0]
  
  # distinguish between publication bias present / absent (for the overall results only)
  if (dgm_name == "Stanley2017") {
    temp_conditional$bias_present <- temp_conditional$condition_id %in% conditions$condition_id[conditions$bias != 0]
    temp_replacement$bias_present <- temp_replacement$condition_id %in% conditions$condition_id[conditions$bias != 0]
  } else if (dgm_name == "Alinaghi2018") {
    temp_conditional$bias_present <- temp_conditional$condition_id %in% conditions$condition_id[conditions$bias != "none"]
    temp_replacement$bias_present <- temp_replacement$condition_id %in% conditions$condition_id[conditions$bias != "none"]
  } else if (dgm_name == "Bom2019") {
    temp_conditional$bias_present <- temp_conditional$condition_id %in% conditions$condition_id[conditions$bias != 0]
    temp_replacement$bias_present <- temp_replacement$condition_id %in% conditions$condition_id[conditions$bias != 0]
  } else if (dgm_name == "Carter2019") {
    temp_conditional$bias_present <- temp_conditional$condition_id %in% conditions$condition_id[conditions$bias != "none"]
    temp_replacement$bias_present <- temp_replacement$condition_id %in% conditions$condition_id[conditions$bias != "none"]
  } 
  
  if (!common_scale) {
    # add rmse and bias ranks (can be reused by the subsequent computations)
    temp_conditional$bias_rank           <- NA
    temp_replacement$bias_rank           <- NA
    temp_conditional$empirical_se_rank   <- NA
    temp_replacement$empirical_se_rank   <- NA
    temp_conditional$rmse_rank           <- NA
    temp_replacement$rmse_rank           <- NA
    temp_conditional$mean_ci_width_rank  <- NA
    temp_replacement$mean_ci_width_rank  <- NA
    temp_conditional$interval_score_rank <- NA
    temp_replacement$interval_score_rank <- NA
    for (condition_id in unique(temp_conditional$condition_id)) {
      temp_conditional$bias_rank[temp_conditional$condition_id == condition_id]           <- rank(abs(temp_conditional$bias[temp_conditional$condition_id == condition_id]), ties.method = "min")
      temp_replacement$bias_rank[temp_replacement$condition_id == condition_id]           <- rank(abs(temp_replacement$bias[temp_replacement$condition_id == condition_id]), ties.method = "min")
      temp_conditional$empirical_se_rank[temp_conditional$condition_id == condition_id]   <- rank(temp_conditional$empirical_se[temp_conditional$condition_id == condition_id], ties.method = "min")
      temp_replacement$empirical_se_rank[temp_replacement$condition_id == condition_id]   <- rank(temp_replacement$empirical_se[temp_replacement$condition_id == condition_id], ties.method = "min")
      temp_conditional$rmse_rank[temp_conditional$condition_id == condition_id]           <- rank(temp_conditional$rmse[temp_conditional$condition_id == condition_id], ties.method = "min")
      temp_replacement$rmse_rank[temp_replacement$condition_id == condition_id]           <- rank(temp_replacement$rmse[temp_replacement$condition_id == condition_id], ties.method = "min")
      temp_conditional$mean_ci_width_rank[temp_conditional$condition_id == condition_id]  <- rank(temp_conditional$mean_ci_width[temp_conditional$condition_id == condition_id], ties.method = "min")
      temp_replacement$mean_ci_width_rank[temp_replacement$condition_id == condition_id]  <- rank(temp_replacement$mean_ci_width[temp_replacement$condition_id == condition_id], ties.method = "min")
      temp_conditional$interval_score_rank[temp_conditional$condition_id == condition_id] <- rank(temp_conditional$interval_score[temp_conditional$condition_id == condition_id], ties.method = "min")
      temp_replacement$interval_score_rank[temp_replacement$condition_id == condition_id] <- rank(temp_replacement$interval_score[temp_replacement$condition_id == condition_id], ties.method = "min")
    }
  }
  
  results_conditional_list[[dgm_name]] <- temp_conditional
  results_replacement_list[[dgm_name]] <- temp_replacement
}

# clean up 
rm("temp_conditional", "temp_replacement", "dgm_name")

results_conditional <- do.call(rbind, results_conditional_list)
results_replacement <- do.call(rbind, results_replacement_list)
method_labels       <- unique(results_conditional$label)
```

```{r, include = FALSE}
# compute average performance
tables_conditional <- make_table_summary(results_conditional, common_scale = common_scale)
tables_replacement <- make_table_summary(results_replacement, common_scale = common_scale)

# add ranks
rankings_conditional <- make_rank_summary(tables_conditional)
rankings_replacement <- make_rank_summary(tables_replacement)
```

`r paste0(generic_overview_text(dgm_names, results_conditional))`

### Average Performance {.tabset .tabset-fade .tabset-pills}

```{r, include = FALSE}
this_rankings_conditional <- rankings_conditional
this_tables_conditional   <- tables_conditional
this_rankings_replacement <- rankings_replacement
this_tables_replacement   <- tables_replacement
```
```{r, child = child_path("_results-tabs-tables.Rmd")}
```

### By-Condition Performance (Conditional on Method Convergence) {.tabset .tabset-fade .tabset-pills}

`r paste0(conditional_text())`

```{r, include = FALSE}
this_results <- results_conditional
```
```{r, child = child_path("_results-tabs-figures.Rmd")}
```


### By-Condition Performance (Replacement in Case of Non-Convergence) {.tabset .tabset-fade .tabset-pills}

`r paste0(method_replacement_text())`

```{r, include = FALSE}
this_results <- results_replacement
```
```{r, child = child_path("_results-tabs-figures.Rmd")}
```
