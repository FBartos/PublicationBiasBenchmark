---
title: "Results: No bias"
author: František Bartoš
output: html_document
vignette: >
  %\VignetteIndexEntry{Results: No bias}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
# use pre-local results if compiled locally
if (dir.exists("C:/R-Packages/PublicationBiasBenchmark/resources")) {
  path <- "C:/R-Packages/PublicationBiasBenchmark/resources"
} else { 
  path <- NULL
}

library(PublicationBiasBenchmark)
library(ggplot2)
library(ggdist)
dgm_name <- "no_bias"
# retrieve all measures across all conditions and measures
download_dgm_measures(dgm_name, path = path)
df  <- retrieve_dgm_measures(dgm_name, path = path)
dfr <- retrieve_dgm_measures(dgm_name, replacement = TRUE, path = path)

# retrieve conditions
conditions <- dgm_conditions(dgm_name)

# add labels
df$label  <- with(df, paste0(method, " (", method_setting, ")"))
dfr$label <- with(dfr, paste0(method, " (", method_setting, ")"))
method_labels <- unique(df$label)

# distinguish between H0 and H1
df$H0  <- df$condition_id %in% conditions$condition_id[conditions$mean_effect == 0]
dfr$H0 <- dfr$condition_id %in% conditions$condition_id[conditions$mean_effect == 0]

# compute average performance
tb <- do.call(rbind, lapply(method_labels, function(ml) with(df[df$label == ml,],
 data.frame(
    "Method"      = unique(method),
    "Setting"     = unique(method_setting),
    "Convergence" = mean(convergence),
    "Bias"        = mean(bias),
    "RMSE"        = mean(rmse),
    "Coverage"    = mean(coverage),
    "Error"       = mean(power[H0]),
    "Power"       = mean(power[!H0])
  ))
))
tbr <- do.call(rbind, lapply(method_labels, function(ml) with(dfr[dfr$label == ml,],
 data.frame(
    "Method"      = unique(method),
    "Setting"     = unique(method_setting),
    "Convergence" = mean(convergence),
    "Bias"        = mean(bias),
    "RMSE"        = mean(rmse),
    "Coverage"    = mean(coverage),
    "Error"       = mean(power[H0]),
    "Power"       = mean(power[!H0])
  ))
))

# add ranks
rb  <- tb
rbr <- tbr
for (measure in c("RMSE", "Coverage", "Error")) {
  rb[[measure]]  <- rank(tb[[measure]], ties.method = "min")
  rbr[[measure]] <- rank(tbr[[measure]], ties.method = "min")
}
for (measure in c("Convergence", "Power")) {
  rb[[measure]]  <- rank(-tb[[measure]], ties.method = "min")
  rbr[[measure]] <- rank(-tbr[[measure]], ties.method = "min")
}
for (measure in c("Bias")) {
  rb[[measure]]  <- rank(abs(tb[[measure]]), ties.method = "min")
  rbr[[measure]] <- rank(abs(tbr[[measure]]), ties.method = "min")
}

# Create raincloud plot function
create_raincloud_plot <- function(data, y_var, y_label, ylim_range = NULL, reference_line = NULL, title_text = NULL) {
  # Generate colors for methods (using a color palette)
  n_methods <- length(unique(data$label))
  method_colors <- rainbow(n_methods, alpha = 0.7)
  names(method_colors) <- unique(data$label)
  
  # Cap values at axis limits if ylim_range is provided
  if (!is.null(ylim_range)) {
    data[[y_var]] <- pmax(ylim_range[1], pmin(ylim_range[2], data[[y_var]]))
  }
  
  p <- ggplot(data, aes(x = label, y = .data[[y_var]], fill = label, color = label)) +
    ggdist::stat_halfeye(
      adjust = 0.5,
      width = 0.6,
      .width = 0,
      justification = -0.2,
      point_colour = NA,
      alpha = 0.7
    ) +
    geom_boxplot(
      width = 0.15,
      outlier.shape = NA,
      alpha = 0.7
    ) +
    geom_point(
      position = position_jitter(width = 0.05, height = 0),
      size = 1,
      alpha = 0.3
    ) +
    scale_fill_manual(values = method_colors) +
    scale_color_manual(values = method_colors) +
    labs(
      x = "",
      y = y_label,
      title = title_text
    )
  
  # Add reference line if provided
  if (!is.null(reference_line)) {
    p <- p + geom_hline(yintercept = reference_line, linetype = "dashed", alpha = 0.7)
  }
  
  p <- p + 
    theme_minimal() +
    theme(
      legend.position = "none",
      axis.text.x = element_text(angle = 45, hjust = 1),
      panel.grid.minor = element_blank(),
      plot.title = element_text(size = 10),
      axis.text.y = element_text(size = 8)
    ) +
    coord_flip()
  
  # Set y-axis limits if provided
  if (!is.null(ylim_range)) {
    p <- p + ylim(ylim_range)
  }
  
  return(p)
}

```

## Average Performance {.tabset .tabset-fade .tabset-pills}

### Conditional on Convergence {.tabset .tabset-fade .tabset-pills}

The results below are conditional on convergence. 
Note that the methods might differ in convergence rate and are therefore not compared on the same data sets.

#### Measures

```{r echo=FALSE} 
DT::formatRound(
  DT::datatable(tb, options = list(pageLength = -1)), 
  columns = c("Convergence", "Bias", "RMSE", "Coverage", "Error", "Power"),
  digits = 3
)
```

#### Ranks

```{r echo=FALSE} 
DT::formatRound(
  DT::datatable(rb, options = list(pageLength = -1)), 
  columns = c("Convergence", "Bias", "RMSE", "Coverage", "Error", "Power"),
  digits = 1
)
```

### Method Replacement  {.tabset .tabset-fade .tabset-pills}

The results below incorporate method replacement. If method fails to converge, its results is replaced by a simpler method. See TODO for details of the method replacement specification.
Note that these results combine do not correspond to "pure" method performance as they might combine multiple different methods.

#### Measures

```{r echo=FALSE} 
DT::formatRound(
  DT::datatable(tbr, options = list(pageLength = -1)), 
  columns = c("Convergence", "Bias", "RMSE", "Coverage", "Error", "Power"),
  digits = 3
)
```

#### Ranks

```{r echo=FALSE} 
DT::formatRound(
  DT::datatable(rbr, options = list(pageLength = -1)), 
  columns = c("Convergence", "Bias", "RMSE", "Coverage", "Error", "Power"),
  digits = 1
)
```


## By-Condition Performance {.tabset .tabset-fade .tabset-pills}

### Conditional on Convergence {.tabset .tabset-fade .tabset-pills}

The results below are conditional on convergence. 
Note that the methods might differ in convergence rate and are therefore not compared on the same data sets.

#### Convergence

```{r fig.height = 8, echo=FALSE, warning=FALSE} 
create_raincloud_plot(df, "convergence", "Convergence", ylim_range = c(0, 1))
```

#### Bias

```{r fig.height = 8, echo=FALSE, warning=FALSE} 
create_raincloud_plot(df, "bias", "Bias", ylim_range = c(-0.5, 0.5), reference_line = 0)
```

Values lower than -0.5 or larger than 0.5 are visualized as -0.5 and 0.5 respectively.

#### RMSE

```{r fig.height = 8, echo=FALSE, warning=FALSE} 
create_raincloud_plot(df, "rmse", "RMSE", ylim_range = c(0, 0.5), reference_line = 0)
```

Values larger than 0.5 are visualized as 0.5.

#### CI Coverage

```{r fig.height = 8, echo=FALSE, warning=FALSE} 
create_raincloud_plot(df, "coverage", "CI Coverage", ylim_range = c(0, 1), reference_line = 0.95)
```

#### Type I Error

```{r fig.height = 8, echo=FALSE, warning=FALSE} 
create_raincloud_plot(df[df$H0,], "power", "Type I Error", ylim_range = c(0, 1), reference_line = 0.05)
```

#### Power

```{r fig.height = 8, echo=FALSE, warning=FALSE} 
create_raincloud_plot(df[!df$H0,], "power", "Power", ylim_range = c(0, 1))
```


### Method Replacement  {.tabset .tabset-fade .tabset-pills}

The results below incorporate method replacement. If method fails to converge, its results is replaced by a simpler method. See TODO for details of the method replacement specification.
Note that these results combine do not correspond to "pure" method performance as they might combine multiple different methods.

#### Convergence

```{r fig.height = 8, echo=FALSE, warning=FALSE} 
create_raincloud_plot(dfr, "convergence", "Convergence", ylim_range = c(0, 1))
```

#### Bias

```{r fig.height = 8, echo=FALSE, warning=FALSE} 
create_raincloud_plot(dfr, "bias", "Bias", ylim_range = c(-0.5, 0.5), reference_line = 0)
```

Values lower than -0.5 or larger than 0.5 are visualized as -0.5 and 0.5 respectively.

#### RMSE

```{r fig.height = 8, echo=FALSE, warning=FALSE} 
create_raincloud_plot(dfr, "rmse", "RMSE", ylim_range = c(0, 0.5), reference_line = 0)
```

Values larger than 0.5 are visualized as 0.5.

#### CI Coverage

```{r fig.height = 8, echo=FALSE, warning=FALSE} 
create_raincloud_plot(dfr, "coverage", "CI Coverage", ylim_range = c(0, 1), reference_line = 0.95)
```

#### Type I Error

```{r fig.height = 8, echo=FALSE, warning=FALSE} 
create_raincloud_plot(dfr[dfr$H0,], "power", "Type I Error", ylim_range = c(0, 1), reference_line = 0.05)
```

#### Power

```{r fig.height = 8, echo=FALSE, warning=FALSE} 
create_raincloud_plot(dfr[!dfr$H0,], "power", "Power", ylim_range = c(0, 1))
```
